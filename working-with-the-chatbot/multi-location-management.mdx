## Multi-Location Management in Business Organizations

One of LeClerk's most sophisticated features is its ability to handle restaurant chains and business organizations with multiple locations. This system allows customers to interact with a brand while automatically routing them to the most appropriate location for their needs.

### Understanding Organization vs Location Mode

LeClerk operates in two distinct modes depending on how a customer initiates contact:

#### Location Mode

- Customer contacts a specific restaurant location directly
- All interactions are scoped to that single location
- Menu, pricing, and availability are location-specific
- Orders are automatically assigned to that location

#### Organization Mode

- Customer contacts the brand/chain generally
- LeClerk must determine the best location to serve them
- Requires address validation and location selection logic
- Can switch between locations during the conversation

### How Organization Mode Works

```mermaid
flowchart TD
    Customer[Customer contacts brand] --> OrgMode[Organization Mode activated]
    OrgMode --> AddressNeeded{Do we have customer address?}

    AddressNeeded -->|No| RequestAddress[Ask for delivery address]
    AddressNeeded -->|Yes| CheckAddress[Validate existing address]

    RequestAddress --> ValidateNew[Validate provided address]
    CheckAddress --> LocationSearch[Find serving locations]
    ValidateNew --> LocationSearch

    LocationSearch --> Found{Locations found?}
    Found -->|Yes| SelectBest[Select optimal location]
    Found -->|No| NoService[No service available]

    SelectBest --> SetContext[Set location context]
    SetContext --> Normal[Continue as location mode]
    NoService --> Alternatives[Suggest alternatives]
```

### Location Selection Algorithm

When multiple locations could serve a customer, LeClerk uses a sophisticated algorithm to choose the best one:

#### Distance-Based Selection

```javascript
// Simplified location scoring
function scoreLocation(location, customerAddress) {
  const distance = calculateDistance(
    location.coordinates,
    customerAddress.coordinates
  );
  const baseScore = Math.max(0, 100 - distance * 10); // Prefer closer locations

  // Adjust for business factors
  let score = baseScore;
  score += location.isOpen ? 20 : -50; // Heavily favor open locations
  score += location.currentLoad < 0.8 ? 10 : -10; // Prefer less busy locations
  score += location.averageRating > 4.5 ? 5 : 0; // Slight preference for high-rated

  return score;
}
```

#### Business Rules

- **Service Area**: Location must actually deliver to the address
- **Operating Hours**: Prefer locations that are currently open
- **Kitchen Capacity**: Avoid overwhelmed kitchens when possible
- **Special Capabilities**: Some locations might have unique menu items or faster service

#### Customer Preferences

- **Previous Orders**: Prefer locations the customer has ordered from before
- **Saved Preferences**: Some customers might have location preferences saved
- **Language**: Match customer language to location staff capabilities

### The Location Switching Process

#### Automatic Location Assignment

```xml
<thinking>
Customer wants delivery to "123 Rue Saint-Antoine, Paris" but we're in organization mode.
I need to check which location can serve this address.
</thinking>

<!-- check_address tool call happens -->

<response_for_customer>
Perfect! I can help you order for delivery to Rue Saint-Antoine.

I've connected you with our Bastille location (closest to your address - just 1.2km away). They can deliver to you in about 30 minutes for ‚Ç¨2.50.

What would you like to order today?
</response_for_customer>
```

#### Customer-Requested Location Switch

```xml
<thinking>
Customer said "Actually, I want to order from your Champs-√âlys√©es location instead."
I need to use the switch_location tool to change their context.
</thinking>

<!-- switch_location tool call -->

<response_for_customer>
No problem! I've switched you to our Champs-√âlys√©es location.

This location can also deliver to your address, but it will take about 45 minutes (‚Ç¨3.50 delivery fee) since it's a bit further. Their menu is the same, but they have some exclusive desserts!

Would you like to see what's available?
</response_for_customer>
```

### Managing Location-Specific Data

#### Menu Variations

Different locations might have:

- **Availability Differences**: Some items sold out at specific locations
- **Pricing Variations**: Different costs based on local factors (rent, wages)
- **Special Items**: Location-exclusive menu items
- **Seasonal Menus**: Different seasonal offerings per location

#### Service Capabilities

- **Delivery Zones**: Each location has its own delivery area
- **Service Types**: Some locations might be pickup-only
- **Operating Hours**: Different hours per location
- **Kitchen Capacity**: Peak hours vary by location

#### Staffing and Languages

- **Language Support**: Locations in different areas might speak different languages
- **Staff Expertise**: Some locations might have specialized knowledge
- **Customer Service Hours**: Phone support availability varies

### Organization-Level Features

#### Brand Consistency

- **Unified Ordering Experience**: Customers feel like they're ordering from one brand
- **Consistent Pricing**: Core items maintain consistent pricing across locations
- **Shared Promotions**: Brand-wide campaigns work across all locations
- **Customer Accounts**: Profiles and history work across all locations

#### Cross-Location Services

```xml
<response_for_customer>
I see you've ordered from our R√©publique location before! Your usual order was:
‚Ä¢ 1x Large Margherita Pizza
‚Ä¢ 1x Tiramisu

Would you like the same thing today, or shall I show you our menu?
</response_for_customer>
```

#### Inventory Sharing

```xml
<thinking>
Customer wants a specific dessert that's out of stock at the assigned location.
Let me check if nearby locations have it available and can help.
</thinking>

<response_for_customer>
That tiramisu is sold out at our Bastille location today, but our R√©publique location (15 minutes away) has it in stock.

Would you like me to:
1. Order from R√©publique instead (45 min delivery)
2. Choose a different dessert from Bastille
3. Skip dessert for today

What works best for you?
</response_for_customer>
```

### Technical Implementation

#### Location Context Management

```python
class LocationContext:
    def __init__(self, organization_id, location_id=None):
        self.organization_id = organization_id
        self.location_id = location_id
        self.effective_location = None

    def set_effective_location(self, location_id):
        """Set the location that will handle this customer's order"""
        self.effective_location = location_id

    def get_menu_context(self):
        """Get menu data for the effective location"""
        if self.effective_location:
            return get_location_menu(self.effective_location)
        return get_organization_menu(self.organization_id)
```

#### Address-to-Location Mapping

```python
def find_serving_locations(address, organization_id):
    """Find all locations that can serve a given address"""
    locations = get_organization_locations(organization_id)
    serving_locations = []

    for location in locations:
        if can_deliver_to(location, address):
            distance = calculate_distance(location.coordinates, address.coordinates)
            score = calculate_location_score(location, address, distance)
            serving_locations.append({
                'location': location,
                'distance': distance,
                'score': score
            })

    return sorted(serving_locations, key=lambda x: x['score'], reverse=True)
```

### Customer Experience Scenarios

#### New Customer Journey

1. **First Contact**: "Hi, I'd like to order pizza"
2. **Address Collection**: "What's your delivery address?"
3. **Location Assignment**: "Great! Our Marais location can deliver to you"
4. **Menu Browsing**: Show location-specific menu and pricing
5. **Order Completion**: Process order through assigned location

#### Returning Customer Journey

1. **Recognition**: "Welcome back! I see you usually order from our Belleville location"
2. **Address Confirmation**: "Delivering to your usual address on Rue Oberkampf?"
3. **Preference Continuity**: "Would you like your usual Large Pepperoni?"
4. **Seamless Ordering**: Quick reorder or menu exploration

#### Complex Scenario Handling

```xml
<thinking>
Customer wants delivery to a new address that's between two of our locations.
Both can deliver, but with different times and fees. I should present options.
</thinking>

<response_for_customer>
I found two locations that can deliver to your new address:

üè™ **Bastille Location**
‚Ä¢ 25 minutes delivery
‚Ä¢ ‚Ç¨2.50 delivery fee
‚Ä¢ All menu items available

üè™ **R√©publique Location**
‚Ä¢ 35 minutes delivery
‚Ä¢ ‚Ç¨3.00 delivery fee
‚Ä¢ Has our exclusive truffle pizza

Which location would you prefer, or shall I just go with the faster option?
</response_for_customer>
```

### Analytics and Optimization

#### Location Performance Tracking

- **Order Volume**: Track orders per location and time period
- **Customer Satisfaction**: Monitor ratings and feedback per location
- **Delivery Performance**: Track delivery times and success rates
- **Menu Performance**: See which items are popular at each location

#### Routing Optimization

- **Load Balancing**: Distribute orders across locations during peak times
- **Delivery Efficiency**: Route customers to locations that can serve them fastest
- **Capacity Management**: Avoid overloading specific locations

#### Business Intelligence

- **Demand Patterns**: Understand customer preferences by location
- **Expansion Planning**: Identify underserved areas
- **Menu Optimization**: Tailor menus to local preferences
- **Staffing Insights**: Optimize staffing based on demand patterns

### Development Considerations

#### Testing Multi-Location Scenarios

```bash
# Test organization mode activation
curl -X POST /message \
  -H "Authorization: Bearer $API_KEY" \
  -d '{
    "organization_id": "org_pizza_palace",
    "customer_message": "I want pizza delivery",
    "mode": "organization"
  }'
```

#### Common Edge Cases

- **Boundary Addresses**: Addresses that multiple locations could serve
- **No Service Areas**: Addresses outside all delivery zones
- **Capacity Limits**: All nearby locations at capacity
- **System Failures**: Location services temporarily unavailable

#### Performance Optimization

- **Location Data Caching**: Cache location information for faster lookups
- **Geographic Indexing**: Use spatial databases for efficient distance calculations
- **Parallel Validation**: Check multiple locations simultaneously
- **Fallback Strategies**: Graceful degradation when services are unavailable

Multi-location management transforms LeClerk from a simple chatbot into an intelligent routing system that provides customers with seamless access to restaurant chains while optimizing operations for the business. Understanding this system is crucial for anyone working on enterprise restaurant solutions.
